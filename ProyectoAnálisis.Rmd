--- 
title: "Proyecto Análisis"
output:
  html_document:
    toc: true
    toc_depth: 2
author: "Maddi Casaiz y Ana Díaz"
date: "`r Sys.Date()`"
--- 


```{r include=FALSE}
library(sf)
library(ggplot2)
library(leaflet)
library(osmdata)
library(dplyr)
library(readr)
library(lubridate)

```

Importar y preparar la base de datos para el estudio que queremos realizar

```{r}
datos <- read_csv("aemet_datos_diarios.csv")
datos$fecha <- as.Date(datos$fecha, format="%Y-%m-%d")
datos$año <- year(datos$fecha)
datos$mes <- month(datos$fecha)
estaciones <- c()

for (mes in datos$mes) {
  if (mes >= 3 && mes <= 5) {
    estaciones <- c(estaciones, 'primavera')
  } else if (mes >= 6 && mes <= 8) {
    estaciones <- c(estaciones, 'verano')
  } else if (mes >= 9 && mes <= 11) {
    estaciones <- c(estaciones, 'otoño')
  } else {
    estaciones <- c(estaciones, 'invierno')
  }
}
datos$estacion <- estaciones
datos$tmax <- as.character(datos$tmax)
datos$tmin <- as.character(datos$tmin)
datos$tmed <- as.character(datos$tmed)
datos$tmax <- parse_number(datos$tmax) / 10  
datos$tmin <- parse_number(datos$tmin) / 10
datos$tmed <- parse_number(datos$tmed) / 10

datos <- datos[!is.na(datos$tmin) & !is.na(datos$tmed) & !is.na(datos$tmax) & !is.na(datos$horatmax) & !is.na(datos$horatmin) & datos$horatmax != 'varias' & datos$horatmin != 'varias', ]
datos$fecha_num <- lubridate::decimal_date(datos$fecha)
```
###1###
#Evolución de las temperaturas a lo largo de los años 

Regresión lineal de las temperaturas desde 2000

```{r}






modelo <- lm(tmed ~ fecha_num, data = datos)
coef = coefficients(modelo)
recta1 = coef[1] + seq(2000,2025,1)* coef[2]
x <- seq(2000,2025,1)
plot(tmed ~ fecha_num, data = datos,
        ylab="Temperatura máxima (°C)",
        xlab="Año",
        main="Temperaturas diarias")

lines(x, recta1, col = "green")

```

Añadamos a esta gráfica las temperaturas mínimas y la temperatura media

```{r}
plot(tmed ~ fecha_num, data = datos,
        ylab="Temperatura máxima (°C)",
        xlab="Año",
        main="Temperaturas diarias")

lines(x, recta1, col = "green")

modelo2  <- lm(tmin ~ fecha_num, data = datos)
coef2 = coefficients(modelo2)
recta2 = coef2[1] + seq(2000,2025,1)* coef2[2]

lines(x, recta2, col = 'blue')

modelo3  <- lm(tmin ~ fecha_num, data = datos)
coef3 = coefficients(modelo3)
recta3 = coef3[1] + seq(2000,2025,1)* coef3[2]

lines(x, recta3, col = 'red')
```

###2###
#Relacion entre las medias de temperatura alta y baja

```{r}
boxplot(tmax ~ tmin, data = datos)
t.test(datos$tmax, datos$tmin, paired = TRUE)

```
#Este boxplot no puede ser así, hay que mirar bien los datos
###3###
#¿El calentamiento afecta a todas las estaciones por igual?
```{r}
#test anova de las distintas estaciones
boxplot(tmed ~ estacion, data = datos)

```
###4###
#Variabilidad por estaciones de hora de temperatura máxima y mínima

En verano
```{r}
modelo  <- lm(horatmax ~ fecha_num, data = datos[datos$estacion == 'verano', ])
coef = coefficients(modelo)
recta1 = coef[1] + seq(2000,2025,1)* coef[2]
x <- seq(2000,2025,1)
plot(horatmax ~ fecha_num, data = datos,
        ylab="Temperatura máxima (°C)",
        xlab="Año",
        main="Temperaturas diarias")
lines(x, recta1)

```
En otoño

```{r}
modelo  <- lm(horatmax ~ fecha_num, data = datos[datos$estacion == 'otoño', ])
coef = coefficients(modelo)
recta1 = coef[1] + seq(2000,2025,1)* coef[2]
x <- seq(2000,2025,1)
plot(horatmax ~ fecha_num, data = datos,
        ylab="Temperatura máxima (°C)",
        xlab="Año",
        main="Temperaturas diarias")
lines(x, recta1)

```
En invierno
```{r}
modelo  <- lm(horatmax ~ fecha_num, data = datos[datos$estacion == 'invierno', ])
coef = coefficients(modelo)
recta1 = coef[1] + seq(2000,2025,1)* coef[2]
x <- seq(2000,2025,1)
plot(horatmax ~ fecha_num, data = datos,
        ylab="Temperatura máxima (°C)",
        xlab="Año",
        main="Temperaturas diarias")
lines(x, recta1)

```

En primavera
```{r}
modelo  <- lm(horatmax ~ fecha_num, data = datos[datos$estacion == 'primavera', ])
coef = coefficients(modelo)
recta1 = coef[1] + seq(2000,2025,1)* coef[2]
x <- seq(2000,2025,1)
plot(horatmax ~ fecha_num, data = datos,
        ylab="Temperatura máxima (°C)",
        xlab="Año",
        main="Temperaturas diarias")
lines(x, recta1)
```
Comparamos las coef[2] de cada una de ellas (la pendiente)
Veamos ahora si la diferencia de medias de horas máximas entre el primer y último año son estadísticamente significativas

```{r}
datos_ultimo = datos[datos$año == 2024, ]
datos_primero = datos[datos$año == 2000, ]
t.test(datos_primero$horatmax, datos_ultimo$horatmax)
```
###5###
#Regresión lineal múltiple para predecir la temperatura máxima diaria
```{r}
pairs(~tmax+tmin+tmed+año+mes+horatmax+horatmin+prec+velmedia+presmin+presmax+hrMedia, data=datos, pch = 16, cex = 0.5)
modelo_mult <- lm(tmax ~ tmin + tmed + año + mes + horatmax + horatmin + prec + velmedia + presmin + presmax + hrMedia, data = datos)
summary(modelo_mult)
vif(modelo_mult)
```

```{r}
pairs(~tmax+tmin+tmed+año+mes+horatmax+horatmin+prec+velmedia+presmin+presmax+hrMedia, data=datos, pch = 16, cex = 0.5)
modelo_mult <- lm(tmax ~ tmin + tmed + año + mes + horatmax + horatmin + prec + velmedia + presmin + presmax + hrMedia, data = datos)
summary(modelo_mult)
vif(modelo_mult)
```

```{r}
fit1  <- lm(tmax ~ ., data = datos)
fit2 <- lm(tmax ~ 1, data = datos)
modelAIC <- step(fit2, scope = list(lower=fit2, upper=fit1), direction="forward")
formula <- formula(modelAIC)
modelFinal <- lm(formula, data = datos)
summary(modelFinal)
vif(modelFinal)
```
#Como podemos ver por el VIF las variables están poco correlacionadas entre sí. Es decir Step AIC ha funcionado correctamente para eliminar las variables que estaban correlacionadas.

###6###

```{r}
#Preparar los datos para su uso
datos2 = read.csv("aemet_datos_diarios_pamplona.csv")
datos2$fecha <- as.Date(datos2$fecha, format="%Y-%m-%d")
datos2$año <- year(datos2$fecha)
datos2$mes <- month(datos2$fecha)
estaciones <- c()

for (mes in datos2$mes) {
  if (mes >= 3 && mes <= 5) {
    estaciones <- c(estaciones, 'primavera')
  } else if (mes >= 6 && mes <= 8) {
    estaciones <- c(estaciones, 'verano')
  } else if (mes >= 9 && mes <= 11) {
    estaciones <- c(estaciones, 'otoño')
  } else {
    estaciones <- c(estaciones, 'invierno')
  }
}
datos2$estacion <- estaciones
datos2$tmax <- as.character(datos2$tmax)
datos2$tmin <- as.character(datos2$tmin)
datos2$tmed <- as.character(datos2$tmed)
datos2$tmax <- parse_number(datos2$tmax) / 10  
datos2$tmin <- parse_number(datos2$tmin) / 10
datos2$tmed <- parse_number(datos2$tmed) / 10

datos2 <- datos2[!is.na(datos2$tmin) & !is.na(datos2$tmed) & !is.na(datos2$tmax), ]
datos2$fecha_num <- lubridate::decimal_date(datos2$fecha)
```
Realizamos todos los analisis que los apartados 1,2 y 5 para la base de datos de aemet_datos_diarios_pamplona

```{r}
medias_anuales2 <- aggregate(tmed ~ año, data = datos2, mean)
#Evolucion de las temperaturas a lo largo de los años 
# Calcular medias anuales para tmax y tmin
medias_tmax <- aggregate(tmax ~ año, data = datos2, mean)
medias_tmin <- aggregate(tmin ~ año, data = datos2, mean)

# Unir a medias_anuales2
medias_anuales2 <- merge(medias_anuales2, medias_tmax, by = "año")
medias_anuales2 <- merge(medias_anuales2, medias_tmin, by = "año")

# Ahora medias_anuales2 tiene las columnas: año, tmed, tmax, tmin
# Ajustar modelos para tmax y tmin
modelo_tmed <- lm(tmed ~ año, data = medias_anuales2)
modelo_tmax <- lm(tmax ~ año, data = medias_anuales2)
modelo_tmin <- lm(tmin ~ año, data = medias_anuales2)

# Coeficientes
coef_tmed <- coefficients(modelo_tmed)
coef_tmax <- coefficients(modelo_tmax)
coef_tmin <- coefficients(modelo_tmin)

# Generar secuencia de años para las rectas
x <- seq(2000, 2025, 1)
recta_tmed <- coef_tmed[1] + x * coef_tmed[2]
recta_tmax <- coef_tmax[1] + x * coef_tmax[2]
recta_tmin <- coef_tmin[1] + x * coef_tmin[2]

# Graficar - vamos a hacer un gráfico con los puntos de tmed, tmax y tmin
plot(tmed ~ año, data = medias_anuales2, 
     ylab = "Temperatura (°C)", 
     xlab = "Año",
     main = "Temperaturas medias, máximas y mínimas anuales",
     ylim = range(medias_anuales2[, c("tmed", "tmax", "tmin")]), 
     pch = 16, col = "black")
points(tmax ~ año, data = medias_anuales2, pch = 16, col = "red")
points(tmin ~ año, data = medias_anuales2, pch = 16, col = "blue")

# Añadir las rectas de tendencia
lines(x, recta_tmed, col = "black")
lines(x, recta_tmax, col = "red")
lines(x, recta_tmin, col = "blue")

# Leyenda
legend("topleft", 
       legend = c("Media", "Máxima", "Mínima"), 
       col = c("black", "red", "blue"), 
       pch = 16, 
       lty = 1)
```
#¿RELACION ENTRE LAS MEDIAS DE TEMPERATURA ALTA Y BAJA?

```{r}
boxplot(tmax ~ tmin, data = datos2)
t.test(datos2$tmax, datos2$tmin, paired = TRUE)
```

#Hacer comparacion de los valores de las betas de las regresiones lineales de uno y otro

####7#####
#HACER PREDICCIONES DE LAS TEMPERATURAS PARA LOS PRÓXIMOS 10 AÑOS
```{r}
modelo_final <- lm(tmax ~ tmin + mes + horatmax + horatmin + prec + velmedia + presmin + presmax + hrMedia, data = datos)
#CAmbiar parámetros por los que salgan en el AICStep
nuevos_datos <- data.frame(
  tmin = c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24),
  mes = c(1,2,3,4,5,6,7,8,9,10),
  horatmax = c(14,14,15,15,16,16,17,17,18,18),
  horatmin = c(6,6,7,7,8,8,9,9,10,10),
  prec = c(0,0,0,0,0,0,0,0,0,0),
  velmedia = c(10,10,10,10,10,10,10,10,10,10),
  presmin = c(1010,1010,1010,1010,1010,1010,1010,1010,1010,1010),
  presmax = c(1025,1025,1025,1025,1025,1025,1025,1025,1025,1025),
  hrMedia = c(60,60,60,60,60,60,60,60,60,60)
) 
#Quizas con un solo dato sea suficiente, está ahora mismo hacienfo 10 predicciones con distintos datos, o podemos buscar datos más extremos
predicciones <- predict(modelo_final, newdata = nuevos_datos)

#ahora repetimos el proceso para pamplona
modelo_final2 <- lm(tmax ~ tmin + mes + horatmax + horatmin + prec + velmedia + presmin + presmax + hrMedia, data = datos2)
nuevos_datos2 <- data.frame(
  tmin = c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24),
  mes = c(1,2,3,4,5,6,7,8,9,10),
  horatmax = c(14,14,15,15,16,16,17,17,18,18),
  horatmin = c(6,6,7,7,8,8,9,9,10,10),
  prec = c(0,0,0,0,0,0,0,0,0,0),
  velmedia = c(10,10,10,10,10,10,10,10,10,10),
  presmin = c(1010,1010,1010,1010,1010,1010,1010,1010,1010,1010),
  presmax = c(1025,1025,1025,1025,1025,1025,1025,1025,1025,1025),
  hrMedia = c(60,60,60,60,60,60,60,60,60,60)
) 
predicciones2 <- predict(modelo_final2, newdata = nuevos_datos2)
```
#cd /workspaces/ProyectoAnalisis 
#R --vanilla --slave -e "rmarkdown::render('ProyectoAnálisis.Rmd')"